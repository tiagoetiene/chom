#!/usr/bin/env node

_ = require("underscore");
args = require('./extract/args');
utils = require('./libs/utils');

var inputFields = program.fields;
var inputDelimiter = ( _.isUndefined( program.delimiter ) == false ) ? program.delimiter : "\n";
var inputCreateObject = ( _.isUndefined( program.createObject ) == false ) ? program.createObject : false;

process.stderr.write("\n");
process.stderr.write( "* chom-extract" + "\n");
process.stderr.write( "  * parameters settings:\n");
process.stderr.write( "    * fields: " + JSON.stringify( inputFields ) + "\n" );
process.stderr.write( "    * delimiter : " + JSON.stringify( inputDelimiter ) + "\n" );
process.stderr.write("\n");

utils.readJSONFromSTDIN( function( datum ) {

	if( _.isEmpty( datum ) ) {
		process.stderr.write("* chom-extract close\n");
		process.exit();
		return;
	}

	if( inputCreateObject == false ) {
		_.each( inputFields, function( field ) {
			process.stdout.write( utils.get( datum, field ) + inputDelimiter );	
		} );	
	} else {
		var obj = {};
		_.each( inputFields, function( field ) {
			utils.set( obj, field, utils.get( datum, field ) );
		} );
		process.stdout.write( JSON.stringify( obj ) + inputDelimiter );	
	}
	
} );